  #-------------------------------------------------------------------------------------
  #  Integrated DQM .cfg file 
  #  Converts .dmp files to Pixel Digis, produces CalibDigis, runs Calibration analysis
  #  Run Raw and Digi sources for DQM, as well as the EDAClient, and produces output
  #  histograms in a root file
  #  ~K. Rose, Rutgers University
  #-------------------------------------------------------------------------------------

process SIPIXELDQM = {
  
  #=========================================================================================
  # Source - SLink dump


  #--------------------------------------------------------------------------------------
  # To run the DQM on a given dataset, replace the below filename with the .dmp file you 
  # wish to run on.  In addition, to run the calibration analysis properly, you must also
  # change the tag for the SiPixelCalibConfigurationRcd further down.
  #--------------------------------------------------------------------------------------

  include "IORawData/SiPixelInputSources/data/PixelSLinkDataInputSource.cfi"
  replace PixelSLinkDataInputSource.fileNames = 
{"file:/FPixData/FPIX/HC+Z1/Runs_warm_256_281_283_298/GainCalibration_298.dmp"}
 #{"rfio:/castor/cern.ch/cms/store/TAC/PIXEL/BPIX/PSI/PixelAlive_347.dmp"}
 #{"rfio:/castor/cern.ch/cms/store/TAC/PIXEL/BPIX/PSI/GainCalibration_415.dmp"}
 #{"rfio:/castor/cern.ch/cms/store/TAC/PIXEL/BPIX/PSI/SCurve_416.dmp"}
# {"rfio:/castor/cern.ch/cms/store/TAC/PIXEL/FPIX/HC-Z1/SCurve_36_340.dmp"}

untracked PSet maxEvents = {untracked int32 input = -1}


  # End Sources
  #=========================================================================================
 
  # MessageLogger service
#   service = Timing{}
   service = MessageLogger{
	untracked vstring destinations = {"cout"}
	untracked PSet cout = {untracked string threshold = "ERROR"}
   }

  #=========================================================================================
    service = AdaptorConfig {}
  #=========================================================================================
  # Geometry
	# Tracker SimGeometryXML
  	include "Geometry/TrackerSimData/data/trackerSimGeometryXML.cfi"
  	# Tracker Geometry Builder
  	include "Geometry/TrackerGeometryBuilder/data/trackerGeometry.cfi"
  	# Tracker Numbering Builder
  	include "Geometry/TrackerNumberingBuilder/data/trackerNumberingGeometry.cfi"
   	# magn. field
   	include "MagneticField/Engine/data/volumeBasedMagneticField.cfi"

  # End Geometry

  include "CondTools/SiPixel/data/SiPixelCalibConfiguration.cfi"

  #----------------------------------------------------------------------------------
  #  If you changed the .dmp filename above, be sure to change the tag for the 
  #  CalibConfigurationRcd below.  Do not change the FedCablingMap unless you're
  #  absolutely sure it's necessary and you know what you're doing.
  #  The full list of available tags can be found at:
  #  https://twiki.cern.ch/twiki/bin/view/CMS/PixelOnlineSoftwareInCMSSW
  #----------------------------------------------------------------------------------

replace sipixelcalib_essource.toGet = {
	{
		string record = "SiPixelCalibConfigurationRcd"
		#string tag = "PixelAlive_PSI_347"
		string tag = "GainCalibration_298"
	},
	{
		string record = "SiPixelFedCablingMapRcd"
		string tag = "SiPixelFedCablingMap_v9"
	}
}

include "CondTools/SiPixel/data/SiPixelGainCalibrationService.cfi"


# Raw to Digi conversion

include "EventFilter/SiPixelRawToDigi/data/SiPixelRawToDigi.cfi"
replace siPixelDigis.InputLabel = "source"
replace siPixelDigis.IncludeErrors = true

# Calibration modules

# CalibDigi producers
include "CalibTracker/SiPixelGainCalibration/data/SiPixelCalibDigiProducer.cfi"

# --------------------------------------------------------------------------
# Calib Analysis modules - all of these can be run regardless of the type of 
# dataset you are running on.  You don't have to comment anything out here.
# --------------------------------------------------------------------------

include "CalibTracker/SiPixelSCurveCalibration/data/SiPixelSCurveCalibrationAnalysis.cfi"
include "CalibTracker/SiPixelIsAliveCalibration/data/SiPixelIsAliveCalibration.cfi"
include "CalibTracker/SiPixelGainCalibration/data/SiPixelGainCalibrationAnalysis.cfi"

 replace siPixelIsAliveCalibration.DetSetVectorSiPixelCalibDigiTag = siPixelCalibDigis
 replace siPixelSCurveAnalysis.DetSetVectorSiPixelCalibDigiTag = siPixelCalibDigis
 replace siPixelGainCalibrationAnalysis.DetSetVectorSiPixelCalibDigiTag = siPixelCalibDigis

 replace siPixelIsAliveCalibration.saveFile = false
 replace siPixelGainCalibrationAnalysis.saveFile = false
 replace siPixelSCurveAnalysis.saveFile = false



# Reconstruction modules

include "RecoLocalTracker/SiPixelRecHits/data/SiPixelRecHits.cfi"

  #=========================================================================================
  # SiPixel DQM Source Modules:
  #=========================================================================================

    # SiPixelMonitorRawData
    	include "DQM/SiPixelMonitorRawData/data/SiPixelMonitorRawData.cfi"

    # SiPixelMonitorDigi
    	include "DQM/SiPixelMonitorDigi/data/SiPixelMonitorDigi.cfi"

  ################ The Client (SiPixelEDAClient) ################
   module sipixelEDAClient = SiPixelEDAClient {
     untracked int32  CollationtionFlag = 0
     untracked int32  FileSaveFrequency = 50
     untracked int32  StaticUpdateFrequency = 10
     untracked string OutputFilePath = "."     
   }
  # End Modules Configuration
  #=========================================================================================
  
  # DQM services

#  	service = DaqMonitorROOTBackEnd{}
#	service = DQMShipMonitoring{ untracked uint32 period = 1000 }
include "DQMServices/Core/data/DQM.cfg"
    module preScaler  = Prescaler{ int32 prescaleFactor = 1 }

    # DQM Online Environment
    module dqmEnv = DQMEventInfo {
	untracked string eventInfoFolder = "EventInfo"
	untracked string subSystemFolder = "Pixel"
    }
    
    # DQM Online File saver module
    module dqmSaver = DQMFileSaver {
        untracked string dirName = "."
	untracked string fileName = "Pixel"
	untracked int32 prescaleLS = 1
	untracked string environment = "Online"
	untracked int32 prescaleEvt = -1
	untracked int32 prescaleTime = -1
	untracked bool saveAtRunEnd = true
	untracked bool saveAtJobEnd = false
    }

  #=========================================================================================

   service = ModuleWebRegistry { }
   service = LockService { untracked vstring labels = { "source" } }

######################## Scheduling
    sequence DigiReco = {
	siPixelDigis
    }

    sequence CalibAnalysis = {
	siPixelCalibDigis,
	siPixelSCurveAnalysis,
	siPixelGainCalibrationAnalysis,
	siPixelIsAliveCalibration
    }

    sequence RAWmonitor = {
      SiPixelRawDataErrorSource
    }
    sequence DIGImonitor = {
      SiPixelDigiSource
    }
    sequence DQMmodules = {
      dqmEnv,
      dqmSaver
    }
    
  # End Schedule
  #=========================================================================================
  #path p = {RAWmonitor,DIGImonitor,sipixelEDAClient,DQMmodules}
  path p = {	
		DigiReco,
		CalibAnalysis,
		RAWmonitor,
		DIGImonitor,
		sipixelEDAClient,
		DQMmodules
	   }

}
