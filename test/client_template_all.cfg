
  #-------------------------------------------------------------------------------------
  #  Integrated DQM .cfg file 
  #  Converts .dmp files to Pixel Digis, produces CalibDigis, runs Calibration analysis
  #  Run Raw and Digi sources for DQM, as well as the EDAClient, and produces output
  #  histograms in a root file
  #  ~K. Rose, Rutgers University
  #-------------------------------------------------------------------------------------

process SIPIXELDQM = {
  
  #=========================================================================================
  # Source - SLink dump


  #--------------------------------------------------------------------------------------
  # To run the DQM on a given dataset, replace the below filename with the .dmp file you 
  # wish to run on.  In addition, to run the calibration analysis properly, you must also
  # change the tag for the SiPixelCalibConfigurationRcd further down.
  #--------------------------------------------------------------------------------------

source = SOURCETYPE{
	untracked vstring fileNames = {"FILENAME"}
	ONEPARAM
	TWOPARAM
}
untracked PSet maxEvents = {untracked int32 input = -1}


DAT untracked PSet options = 
DAT	{
DAT		untracked vstring Rethrow = {"ProductNotFound", "TooManyProducts", "TooFewProducts"}
DAT	}
DAT
DAT module datconverter = StreamThingAnalyzer {string product_to_get="m2"}



  # End Sources
  #=========================================================================================
 
  # MessageLogger service
#   service = Timing{}
   service = MessageLogger{
	untracked vstring destinations = {"TEXTFILE.log"}
	untracked PSet TEXTFILE.log = {untracked string threshold = "ERROR"}
   }
 
  #=========================================================================================
    service = AdaptorConfig {}
  #=========================================================================================
  # Geometry
	# Tracker SimGeometryXML
  	include "Geometry/TrackerSimData/data/trackerSimGeometryXML.cfi"
  	# Tracker Geometry Builder
  	include "Geometry/TrackerGeometryBuilder/data/trackerGeometry.cfi"
  	# Tracker Numbering Builder
  	include "Geometry/TrackerNumberingBuilder/data/trackerNumberingGeometry.cfi"
   	# magn. field
   	include "MagneticField/Engine/data/volumeBasedMagneticField.cfi"

  # End Geometry

#  include "CondTools/SiPixel/data/SiPixelCalibConfiguration.cfi"

  #-------------------------------------------------------------------------------
  #  If you changed the .dmp filename above, be sure to change the tag for the 
  #  CalibConfigurationRcd below.  Do not change the FedCablingMap unless you're
  #  absolutely sure it's necessary and you know what you're doing.
  #  The full list of available tags can be found at:
  #  https://twiki.cern.ch/twiki/bin/view/CMS/PixelOnlineSoftwareInCMSSW
  #----------------------------------------------------------------------------------

include "CondCore/DBCommon/data/CondDBCommon.cfi"
replace CondDBCommon.connect = "oracle://cms_orcoff_int2r/CMS_COND_TIF_PIXELS"
replace CondDBCommon.DBParameters.authenticationPath = "/afs/cern.ch/cms/DB/conddb"

include "CalibTracker/Configuration/data/SiPixelGain/SiPixelGain_Fake.cff"
include "CalibTracker/Configuration/data/SiPixelLorentzAngle/SiPixelLorentzAngle_Fake.cff"

es_source = PoolDBESSource{
	using CondDBCommon
VPSet toGet = {
OLD	{
OLD		string record = "SiPixelCalibConfigurationRcd"
OLD		#string tag = "GainCalibration_1310"
OLD		string tag = "TAG"
OLD		#string tag = "GainCalibration_298"
OLD	},
OLD	{
OLD		string record = "SiPixelFedCablingMapRcd"
OLD		string tag = "SiPixelFedCablingMap_v13"
OLD		#string tag = "SiPixelFedCablingMap_v9"
OLD	}

	
}
NEW 	untracked string globaltag = "PIXELCALIB_01::TypeGLOBALCALIB"
	untracked string BlobStreamerName = "TBufferBlobStreamingService"
}
include "CondTools/SiPixel/data/SiPixelGainCalibrationService.cfi"

# Raw to Digi conversion

include "EventFilter/SiPixelRawToDigi/data/SiPixelRawToDigi.cfi"
replace siPixelDigis.InputLabel = "source"
replace siPixelDigis.IncludeErrors = true

# Calibration modules

# CalibDigi producers
include "CalibTracker/SiPixelGainCalibration/data/SiPixelCalibDigiProducer.cfi"

# --------------------------------------------------------------------------
# Calib Analysis modules - all of these can be run regardless of the type of 
# dataset you are running on.  You don't have to comment anything out here.
# --------------------------------------------------------------------------

include "CalibTracker/SiPixelSCurveCalibration/data/SiPixelSCurveCalibrationAnalysis.cfi"
include "CalibTracker/SiPixelIsAliveCalibration/data/SiPixelIsAliveCalibration.cfi"
include "CalibTracker/SiPixelGainCalibration/data/SiPixelGainCalibrationAnalysis.cfi"

 replace siPixelIsAliveCalibration.DetSetVectorSiPixelCalibDigiTag = siPixelCalibDigis
 replace siPixelSCurveAnalysis.DetSetVectorSiPixelCalibDigiTag = siPixelCalibDigis
 replace siPixelGainCalibrationAnalysis.DetSetVectorSiPixelCalibDigiTag = siPixelCalibDigis

 replace siPixelIsAliveCalibration.saveFile = false
 replace siPixelGainCalibrationAnalysis.saveFile = false
 replace siPixelSCurveAnalysis.saveFile = false
replace siPixelSCurveAnalysis.writeOutThresholdSummary = false


# Reconstruction modules
include "RecoLocalTracker/SiPixelClusterizer/data/SiPixelClusterizer.cfi"
include "RecoLocalTracker/SiPixelRecHits/data/PixelCPEESProducers.cff"
include "RecoLocalTracker/SiPixelRecHits/data/SiPixelRecHits.cfi"

  #=========================================================================================
  # SiPixel DQM Source Modules:
  #=========================================================================================

    # SiPixelMonitorRawData
    	include "DQM/SiPixelMonitorRawData/data/SiPixelMonitorRawData.cfi"

    # SiPixelMonitorDigi
    	include "DQM/SiPixelMonitorDigi/data/SiPixelMonitorDigi.cfi"

	include "DQM/SiPixelMonitorCluster/data/SiPixelMonitorCluster.cfi"
	include "DQM/SiPixelMonitorRecHit/data/SiPixelMonitorRecHit.cfi"

  ################ The Client (SiPixelEDAClient) ################
   module sipixelEDAClient = SiPixelEDAClient {
     untracked int32  CollationtionFlag = 0
     untracked int32  FileSaveFrequency = 50
     untracked int32  StaticUpdateFrequency = 10
     untracked string OutputFilePath = "."     
   }
  # End Modules Configuration
  #=========================================================================================
  
  # DQM services

#  	service = DaqMonitorROOTBackEnd{}
#	service = DQMShipMonitoring{ untracked uint32 period = 1000 }
    include "DQMServices/Core/data/DQM.cfg"
    module preScaler  = Prescaler{ int32 prescaleFactor = 1 }
replace DQM.collectorHost = ""

    include "DQMServices/Components/data/DQMEnvironment.cfi"
    replace dqmSaver.convention    = "Online"
    replace dqmSaver.producer        = "DQM"
    replace dqmEnv.subSystemFolder   = "Pixel"
    # replace dqmSaver.forceRunNumber  = -1
    replace dqmSaver.saveByLumiSection =  -1
    # replace dqmSaver.saveByMinute = -1
    # replace dqmSaver.saveByEvent =  -1
    replace dqmSaver.saveByRun =     1
    replace dqmSaver.saveAtJobEnd = true

    module qTester = QualityTester {
      untracked FileInPath qtList =
"DQM/SiPixelMonitorClient/test/sipixel_qualitytest_config.xml"
      untracked bool getQualityTestsFromFile = true
      untracked int32 QualityTestPrescaler = 1
    }

    

  #=========================================================================================

   service = ModuleWebRegistry { }
   service = LockService { untracked vstring labels = { "source" } }

######################## Scheduling
    sequence DigiReco = {
	siPixelDigis,
	siPixelClusters,
	siPixelRecHits
    }

    sequence CalibAnalysis = {
	siPixelCalibDigis,
	siPixelSCurveAnalysis,
	siPixelGainCalibrationAnalysis,
	siPixelIsAliveCalibration
    }

    sequence RAWmonitor = {
      SiPixelRawDataErrorSource
    }
    sequence DIGImonitor = {
      SiPixelDigiSource
    }
    sequence CLUmonitor = {
      SiPixelClusterSource
    }
    sequence RECmonitor = {
      SiPixelRecHitSource
    }
    sequence DQMmodules = {
      qTester,
      dqmEnv,
      dqmSaver
    }
    
  # End Schedule
  #=========================================================================================
  #path p = {RAWmonitor,DIGImonitor,sipixelEDAClient,DQMmodules}
  path p = {	
		siPixelDigis,
		siPixelClusters,
		siPixelRecHits,
		CalibAnalysis,
		RAWmonitor,
		DIGImonitor,
		CLUmonitor,
		RECmonitor,
		sipixelEDAClient,
		DQMmodules
		
	   }

}
